#define _GNU_SOURCE
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/prctl.h>
#include <unistd.h>

int main() {
  const char *filename = "/home/user/secret_file";

  printf("Malware process started. PID: %d\n", getpid());

  printf("malware process started. Opening file: %s\n", filename);

  int fd = open(filename, O_RDWR | O_CREAT, 0644);
  if (fd < 0) {
    perror("open");
    return 1;
  }

  // 保持进程运行，方便你观察
  for (int i = 0; i < 3; ++i) {
    sleep(5);
  }

  // Write a passwd-style entry adding user "hacker"
  printf("[$] Start writing\n");
  const char *passwd_entry =
      "hacker:x:1001:1001:hacker:/home/hacker:/bin/bash\n";
  ssize_t n = write(fd, passwd_entry, strlen(passwd_entry));
  if (n < 0) {
    perror("write");
    return 1;
  }
  printf("[$] Write done\n");

  close(fd);
  return 0;
}
